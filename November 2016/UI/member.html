<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>MSR Window</title>

	<!-- Bootstrap -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
	
	<!-- React -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/react/15.3.1/react.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/react/15.3.1/react-dom.js"></script>
	
	<!-- Babel -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.34/browser.min.js"></script>
	
	<!-- Code -->
	<script src="Config.js"></script>
	<script src="Services.js"></script>
	<script src="Utils.js"></script>
	
	<script type="text/babel">
	class BasicInfo extends React.Component {
		render() {
			var values = [];
			var i=0;
			Object.getOwnPropertyNames(this.props.member).forEach((p) => {
				if(['first_name', 'last_name'].indexOf(p) >= 0)
					return;
					
				var key = (i++).toString();
				values.push(<BasicProperty name={p} value={this.props.member[p]} key={key} />);
			});
			return (
				<div className="panel panel-default">
					<div className="panel-heading">
						<h2>
							{this.props.member.first_name} {this.props.member.last_name}
							<small className="pull-right">Member ID: <strong>{this.props.member.id}</strong></small>
						</h2>
					</div>
					<div className="panel-body row">
						<div className="col-md-6">
							<h4>Personal Information</h4>
							<dl className="dl-horizontal">
								<dt>Gender</dt>
								<dd>{this.props.member.gender}</dd>
								<dt>Birthday</dt>
								<dd>{this.props.member.dob}</dd>
								<dt>SSN</dt>
								<dd>{this.props.member.ssn}</dd>
								<dt>Marital Status</dt>
								<dd>{this.props.member.marital_status}</dd>
							</dl>
						</div>
						<div className="col-md-6">
							<h4>Contact Information</h4>
							<dl className="dl-horizontal">
								<dt>Home Phone Number</dt>
								<dd>{this.props.member.home_phone}</dd>
								<dt>Email Address</dt>
								<dd>{this.props.member.email}</dd>
								<dt>Home Address</dt>
								<dd>
									<address>
										{this.props.member.street_address}<br />
										{this.props.member.city}, {this.props.member.state}<br />
										{this.props.member.country} ({this.props.member.country_code})
									</address>
								</dd>
							</dl>
						</div>
					</div>
				</div>
			);
		}
	};
	class BasicProperty extends React.Component {
		render() {
			return (
				<div className="col-md-3">
					<dl className="dl-horizontal"><dt>{this.props.name}</dt><dd>{this.props.value}</dd></dl>
				</div>
			);
		}
	};
	
	class MilitaryService extends React.Component {
		render() {
			var rows = [];
			var i = 0;
			
			if(!this.props.member.military)
				this.props.member.military = [];
			
			this.props.member.military.forEach(function(military) {
				var key = (i++).toString();
				rows.push(<MilitaryInstance service={military} key={key} />);
			});
			return (
				<div className="panel panel-default">
					<div className="panel-heading">
						<h3>Military Service</h3>
					</div>
					<table className="table">
						<thead>
							<tr><th>Branch</th><th>Status</th></tr>
						</thead>
						<tbody>
							{rows}
						</tbody>
					</table>
				</div>
			);
		}
	};
	class MilitaryInstance extends React.Component {
		render() {
			return (
				<tr>
					<td>{this.props.service.branch}</td>
					<td>{this.props.service.status}</td>
				</tr>
				);
		}
	};
	
	class Identifications extends React.Component {
		render() {
			var rows = [];
			var i=0;
			
			if(!this.props.member.identification)
				this.props.member.identification = [];
			
			this.props.member.identification.forEach(function(id) {
				var key = (i++).toString();
				rows.push(<Identification id={id} key={key} />);
			});
			
			return (
				<div className="panel panel-default">
					<div className="panel-heading">
						<h3>Identifications</h3>
					</div>
					<table className="table table-striped">
						<thead>
							<tr><th>ID Type</th><th>ID Number</th><th>Validity</th></tr>
						</thead>
						<tbody>
							{rows}
						</tbody>
					</table>
				</div>
			);
		}
	};
	class Identification extends React.Component {
		render() {
			var validity = this.props.id.valid ? 'Valid' : <strong>Invalid</strong>
			return (
				<tr>
					<td>{this.props.id.type}</td>
					<td>{this.props.id.number}</td>
					<td>{validity}</td>
				</tr>
			);
		}
	};
	
	
	class Products extends React.Component {
		render() {
			var rows = [];
			var i=0;
			
			if(!this.props.member.product)
				this.props.member.product = [];
			
			this.props.member.product.forEach(function(product) {
				var key = (i++).toString();
				rows.push(<Product product={product} key={key} />);
			});
			
			return (
				<div className="panel panel-default">
					<div className="panel-heading">
						<h3>Products</h3>
					</div>
					<table className="table table-striped">
						<thead>
							<tr><th>Product</th><th>ID Number</th></tr>
						</thead>
						<tbody>
							{rows}
						</tbody>
					</table>
				</div>
			);
		}
	};
	class Product extends React.Component {
		render() {
			return (
				<tr>
					<td>{this.props.product.type}</td>
					<td>{this.props.product.number}</td>
				</tr>
			);
		}
	};
	
	class MemberNotFound extends React.Component {
		render() {
			return (
				<div className="panel panel-warning">
					<div className="panel-heading">
						<h3>Member Not Found</h3>
					</div>
					<div className="panel-body">
						<h4>We could not find the member that you were searching for</h4>
						<p>Please return to <a href="index.html">the Search Page</a> to search for another member.</p>
					</div>
				</div>
			);
		}
	};
	
	class RowInput extends React.Component {
		constructor(props) {
			super(props);
			
			this.handleChange = this.handleChange.bind(this);
		}
		
		handleChange(event) {
			this.props.onChange(this.props.propertyName, this.textInput.value);
		}
		
		render() {
			if(this.props.mode === 'render') {
				return (
					<div>
						<dt>{this.props.name}</dt>
						<dd>{this.props.value}</dd>
					</div>
				);
			} else {
				var id = 'value_' + this.props.propertyName;
				var errors = (this.props.errors || []).join('<br />')
				
				return (
					<div className="form-group">
						<label htmlFor={id} className="col-sm-4 control-label">
							{this.props.name}
						</label>
						<div className="col-sm-8">
						  <input className="form-control" type="text" id={id} name={id} 
							value={this.props.value} 
							ref={(input) => { this.textInput = input; }}
							onChange={this.handleChange} />
							<p className="text-danger">{errors}</p>
						</div>
					</div>
				);
			
			}
		}
	};
	class RowSelect extends React.Component {
		constructor(props) {
			super(props);
			
			this.handleChange = this.handleChange.bind(this);
		}
		
		handleChange(event) {
			this.props.onChange(this.props.propertyName, this.textInput.value);
		}
		
		render() {
			if(this.props.mode === 'render') {
				return (
					<div>
						<dt>{this.props.name}</dt>
						<dd>{this.props.value}</dd>
					</div>
				);
			} else {
				var id = 'value_' + this.props.propertyName;
				
				var options = [];
				for(var i=0,option;option=this.props.options[i];i++) {
					options.push(
						<option value={option} key={i}>{option}</option>
						);
				}
				
				
				return (
					<div className="form-group">
						<label htmlFor={id} className="col-sm-4 control-label">
							{this.props.name}
						</label>
						<div className="col-sm-8">
						  <select className="form-control" type="text" id={id} name={id} 
							value={this.props.value} 
							ref={(input) => { this.textInput = input; }}
							onChange={this.handleChange}>
							{options}
						</select>
						</div>
					</div>
				);
			
			}
		}
	};
	
	class InfoBox extends React.Component {
		constructor(props) {
			super(props);
			this.state = {
				id: props.member.id, 
				changed: false,
				changeError: '',
				newValue: JSON.parse(JSON.stringify(props.member)),
				oldValue: props.member,
				mode: 'render'
			};
			
			this.handleToggleMode = this.handleToggleMode.bind(this);
			this.handleChange = this.handleChange.bind(this);
			this.handleCancel = this.handleCancel.bind(this);
			this.handleSubmit = this.handleSubmit.bind(this);
		}
		
		handleToggleMode(event) {
			var mode = this.state.mode === 'render' ? 'edit' : 'render';

			this.setState({
				mode: mode
			});
		}
		
		handleChange(property, value) {
			console.log({ value: value, property: property });
			
			var newValue = this.state.newValue;
			
			newValue[property] = value;
			
			this.setState({
				changed: true,
				newValue: newValue,
				changeError: ''
			});
		}
		
		handleCancel(event) {
			this.setState({
				newValue: JSON.parse(JSON.stringify(this.state.oldValue)),
				changeError: ''
			});
			this.handleToggleMode();
		}
		
		handleValidationError(errors) {
			
		}
		
		handleSubmit(event) {
			if(!this.state.changed) {
				this.setState({
					changeError: 'No change detected'
				});
				return false;
			}
			this.putData(this.state.id, this.state.newValue, _ => { this.getData() }, 
				function(x,s,e) {
					console.error({
						x: x,
						s: x,
						e: e
					});
				});
		}
		
		render() {
			var isEdit = this.state.mode === 'edit';
			var i = 0;
			var rows = this.getRows();
			return (
				<div className="panel panel-default">
					<div className="panel-heading" ref="heading">
						<h3>
							<button onClick={this.handleToggleMode} 
								className="btn btn-default pull-right">Edit</button>
							{this.getTitle()}
						</h3>
					</div>
					<div className="panel-body" ref="body">
						{ isEdit ? (
						<form className="form-horizontal"> 
							{rows}
						</form>
						) : ( 
						<dl className="dl-horizontal"> 
							{rows}
						</dl> 
						) }
					</div>
					{ isEdit && (
					<div className="panel-footer" ref="footer">
						<div className="pull-right">
							<p className="text-danger">
								{this.state.changeError}
								&nbsp;&nbsp;
								<button onClick={this.handleSubmit} className="btn btn-primary">Save</button>
							</p>
						</div>
						<button onClick={this.handleCancel} className="btn btn-link">Cancel</button>
					</div>
					)}
				</div>
			);
		
		}
	};
	
	class EmploymentInfo extends InfoBox
	{
		getData() {	
			services.getEmployment(
				this.state.id,
				(response) => {
					renderEmploymentInformation(response);
					this.handleToggleMode()
				},
				function(x,s,e) {
					console.error({
						x: x,
						s: x,
						e: e
					});
					//handleError(document.getElementById('edit-employment'), 'Employment', e, x);
				});
		}
		
		getRows() {
			var i=0;
			return [
				<RowInput mode={this.state.mode} value={this.state.newValue.occupation} name="Occupation" propertyName="occupation" onChange={this.handleChange} key={i++} />,
				<RowInput mode={this.state.mode} value={this.state.newValue.employer} name="Employer" propertyName="employer" onChange={this.handleChange} key={i++} />
			];
		}
		getTitle() {
			return 'Employment Information';
		}
		putData(a,b,c,d) {
			return services.putEmployment(a,b,c,d);
		}
	};
	class ContactInformation extends InfoBox
	{
		getData() {	
			services.getContactInformation(
				this.state.id,
				(response) => {
					renderContactInformation(response);
					this.handleToggleMode()
				},
				function(x,s,e) {
					console.error({
						x: x,
						s: x,
						e: e
					});
					//handleError(document.getElementById('edit-employment'), 'Employment', e, x);
				});
		}
		
		getRows() {
			var i=0;
			return [
				<RowInput mode={this.state.mode} value={this.state.newValue.email} name="Email" propertyName="email" onChange={this.handleChange} key={i++} />,
				<RowInput mode={this.state.mode} value={this.state.newValue.street_address} name="Street Address" propertyName="street_address" onChange={this.handleChange} key={i++} />,
				<RowSelect mode={this.state.mode} value={this.state.newValue.state} name="State" propertyName="state" onChange={this.handleChange} key={i++} 
					options={Utils.getStates()} />,
				<RowInput mode={this.state.mode} value={this.state.newValue.home_phone} name="Home Phone Number" propertyName="home_phone" onChange={this.handleChange} key={i++} />,
				<RowInput mode={this.state.mode} value={this.state.newValue.city} name="City" propertyName="city" onChange={this.handleChange} key={i++} />,
				<RowInput mode={this.state.mode} value={this.state.newValue.country} name="Country" propertyName="country" onChange={this.handleChange} key={i++} />,
				<RowInput mode={this.state.mode} value={this.state.newValue.country_code} name="Country Code" propertyName="country_code" onChange={this.handleChange} key={i++} />
			];
		}
		getTitle() {
			return 'Contact Information';
		}
		putData(a,b,c,d) {
			return services.putContactInformation(a,b,c,d);
		}
	};
	class PersonalInformation extends InfoBox
	{
		getData() {	
			services.getPersonalInformation(
				this.state.id,
				(response) => {
					renderPersonalInformation(response);
					this.handleToggleMode()
				},
				function(x,s,e) {
					console.error({
						x: x,
						s: x,
						e: e
					});
					//handleError(document.getElementById('edit-employment'), 'Personal', e, x);
				});
		}
		
		getRows() {
			var i=0;
			return [
				<RowInput mode={this.state.mode} value={this.state.newValue.first_name} name="First Name" propertyName="first_name" onChange={this.handleChange} key={i++} />,
				<RowInput mode={this.state.mode} value={this.state.newValue.last_name} name="Last Name" propertyName="last_name" onChange={this.handleChange} key={i++} />,
				<RowInput mode={this.state.mode} value={this.state.newValue.dob} name="Date of Birth" propertyName="dob" onChange={this.handleChange} key={i++} />,
				<RowInput mode={this.state.mode} value={this.state.newValue.ssn} name="Social Security Number" propertyName="ssn" onChange={this.handleChange} key={i++} />,
				<RowSelect mode={this.state.mode} value={this.state.newValue.gender} name="Gender" propertyName="gender" onChange={this.handleChange} key={i++} 
					options={['Male', 'Female']} />,
				<RowSelect mode={this.state.mode} value={this.state.newValue.marital_status} name="Marital Status" propertyName="marital_status" onChange={this.handleChange} key={i++} 
					options={['Single', 'Married', 'Divorced', 'Widowed']}/>
			];
		}
		getTitle() {
			return 'Personal Information';
		}
		putData(a,b,c,d) {
			return services.putPersonalInformation(a,b,c,d);
		}
	};
	
	function handleError(element, type, error, xhr) {
		if(xhr) 
			console.error(xhr);
		else
			console.error(error);
		
		
		function toString(err, messages) {
			
			if(typeof err === 'string') {
				messages.push(err);
				return;
			}
			for(var prop in err) {
				var parsed = null;
				try {
					if(typeof error[prop] == 'object')
						return toString(error[prop], messages);
					
					parsed = JSON.parse(error[prop]);
					
					if(typeof parsed == 'object')
						toString(parsed, messages);
					else
						messages.push('<p><strong>' + prop + ':</strong> ' + err[prop] + '</p>');
				} catch(x) {
					messages.push('<p><strong>' + prop + ':</strong> ' + err[prop] + '</p>');
				}
			}
		}
		element.className = 'panel panel-danger';
		var texts = [];
		toString(error, texts);
		
		if(xhr) {
			try {
				var body = xhr.responseJSON;
				toString(body, texts);
			} catch (x) { }
		}
		
		
		element.innerHTML = '<div class="panel-heading"><h4>' + type + '</h4></div><div class="panel-body"><p>There was a problem retrieving the ' + 
		type + ' data for this user.</p>' +
		'<pre>'+ texts.join('') + '</pre></div>';
	}
	
	var services;
	function renderEmploymentInformation(response) {
		try {
			var member = response.body.Item;
			ReactDOM.render(
				<EmploymentInfo member={member} />,
				document.getElementById('employment')
				);
		} catch(e) {
			handleError(document.getElementById('employment'), 'Employment', e, response);
		}
	}
	function renderContactInformation(response) {
		try {
			var member = response.body.Item;
			ReactDOM.render(
				<ContactInformation member={member} />,
				document.getElementById('contact')
				);
		} catch(e) {
			handleError(document.getElementById('contact'), 'Contact Information', e, response);
		}
	}
	function renderPersonalInformation(response) {
		try {
			var member = response.body.Item;
			ReactDOM.render(
				<PersonalInformation member={member} />,
				document.getElementById('personal')
				);
		} catch(e) {
			handleError(document.getElementById('personal'), 'Personal Information', e, response);
		}
	}

	$(document).ready(function() {
		var memberid = Utils.getParameterByName('id');
		
		if(memberid == null || memberid == "")
		{
			ReactDOM.render(
				<MemberNotFound />,
				document.getElementById('member-not-found')
				);
			return;
		}
		
		services = new Services(
			Config.ServiceResourceUrl,
			Config.ApiKey,
			Config.ChaosMonkeyOdds
			);
		/*
		services.getBasicInformation(
			memberid,
			function(response) {
				try {
					var member = response.body.Item;
					ReactDOM.render(
						<BasicInfo member={member} />,
						document.getElementById('basic-info')
						);
				} catch(e) {
					handleError(document.getElementById('basic-info'), 'Basic Information', response);
				}},
			function(x,s,e) {
				handleError(document.getElementById('basic-info'), 'Basic Information', e, x);
			});*/
		
		services.getMilitaryService(
			memberid,
			function(response) {
				try {
					var member = response.body.Item;
					ReactDOM.render(
						<MilitaryService member={member} />,
						document.getElementById('military-service')
						);
				} catch(e) {
					handleError(document.getElementById('military-service'), 'Military Service', response);
				}},
			function(x,s,e) {
				handleError(document.getElementById('military-service'), 'Military Service', e, x);
			});
		
		services.getIdentifications(
			memberid,
			function(response) {
				try {
					var member = response.body.Item;
					ReactDOM.render(
						<Identifications member={member} />,
						document.getElementById('identifications')
						);
				} catch(e) {
					handleError(document.getElementById('identifications'), 'Identifications', response);
				}},
			function(x,s,e) {
				handleError(document.getElementById('identifications'), 'Identifications', e, x);
			});
		
		services.getProducts(
			memberid,
			function(response) {
				try {
					var member = response.body.Item;
					ReactDOM.render(
						<Products member={member} />,
						document.getElementById('products')
						);
				} catch(e) {
					handleError(document.getElementById('products'), 'Products', response);
				}},
			function(x,s,e) {
				handleError(document.getElementById('products'), 'Products', e, x);
			});
		
		
		services.getEmployment(
			memberid,
			renderEmploymentInformation,
			function(x,s,e) {
				handleError(document.getElementById('employment'), 'Employment', e, x);
			});
			
		services.getContactInformation(
			memberid,
			renderContactInformation,
			function(x,s,e) {
				handleError(document.getElementById('contact'), 'Contact Information', e, x);
			});
			
		services.getPersonalInformation(
			memberid,
			renderPersonalInformation,
			function(x,s,e) {
				handleError(document.getElementById('personal'), 'Personal Information', e, x);
			});
	});
	</script>
  </head>
  <body>
  	<div class="container-fluid">
	    <h1>
    		MSR Window
    	</h1>
		<hr />
		
		<div id="member-not-found"></div>
		<!--<div id="basic-info" class="panel"></div>-->
		<div class="row">
			<div class="col-md-4">
				<div id="personal" class="panel"></div>
			</div>
			<div class="col-md-4">
				<div id="contact" class="panel"></div>
			</div>
			<div class="col-md-4">
				<div id="employment" class="panel"></div>
			</div>
		</div>
		
		<div class="row">
			<div class="col-md-6">
				<div id="military-service" class="panel"></div>
				<div id="identifications" class="panel"></div>
			</div>
			<div class="col-md-6">
				<div id="products" class="panel"></div>
			</div>
		</div>
		
		
   </div>
  </body>
</html>